apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: aplications-alerts
  namespace: prometheus-stack
  labels:
    app.kubernetes.io/name: kube-prometheus-stack
    app.kubernetes.io/instance: kube-prometheus-stack
    app.kubernetes.io/managed-by: Helm
    prometheus: kube-prometheus-stack-prometheus
    role: alert-rules
spec:
  groups:
    # Application-specific alerts
    - name: applications.health
      interval: 60s
      rules:
        - alert: ApplicationHighMemoryUsage
          expr: (container_memory_working_set_bytes{container!="POD",container!=""} / container_spec_memory_limit_bytes) * 100 > 90
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "Container {{ $labels.container }} in {{ $labels.namespace }}/{{ $labels.pod }} has high memory usage"
            description: "Container {{ $labels.container }} memory usage is above 90% of its limit (current value: {{ printf \"%.2f\" $value }}%)"
        - alert: ApplicationHighCPUUsage
          expr: (rate(container_cpu_usage_seconds_total{container!="POD",container!=""}[5m])) / (container_spec_cpu_quota{container!="POD",container!=""}/container_spec_cpu_period{container!="POD",container!=""}) * 100 > 90
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "Container {{ $labels.container }} in {{ $labels.namespace }}/{{ $labels.pod }} has high CPU usage"
            description: "Container {{ $labels.container }} CPU usage is above 90% of its limit (current value: {{ printf \"%.2f\" $value }}%)"
    # Application Pod Network Alerts
    - name: network.connectivity
      interval: 30s
      rules:
        - alert: PodNetworkUnavailable
          expr: kube_pod_status_phase{phase="Running"} unless on (namespace, pod) kube_pod_status_ready{condition="True"}
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "Pod {{ $labels.namespace }}/{{ $labels.pod }} network may be unavailable"
            description: "Pod {{ $labels.namespace }}/{{ $labels.pod }} is running but not ready, which may indicate network issues."